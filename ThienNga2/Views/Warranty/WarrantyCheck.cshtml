@using ThienNga2.Models;
@using ThienNga2.Models.Entities;

<!DOCTYPE html>

<html>
<head>

    <meta name="viewport" content="width=device-width" />
    <title>Inventory</title>
    <link rel="stylesheet" type="text/css" href="~/Content/SearchBar.css">
    <link rel="stylesheet" type="text/css" href="~/Content/Table.css">
    <link rel="stylesheet" href="~/Content/jquery-ui.css" type="text/css">
    <script src="http://www.google.com/jsapi"></script>

    <script>

        $(document).ready(function () {
            $('#CodeText').autocomplete({
                source: '@Url.Action("Autocomplete")'

            });
            $(".ui-helper-hidden-accessible").hide();
            $('#item_status').click(function () {

                if ($('#item_status').val() == 4) {
                    $("#dateBanGiao").attr('style', '');
                }
                if ($('#item_status').val() == 4) {
                    $("#dateFinish").attr('style', '');
                }

            });

            $('#startWarranty').click(function () {
                $('#newWarrantyForm').attr('style', '');
            });



        });
    </script>
    <script>
        $(document).ready(function () {
            $('#searchID').autocomplete({
                source: '@Url.Action("Autocomplete")'

            })
                .data("ui-autocomplete")._renderItem = function (ul, item) {
                    return $("<li>")
                      .data("ui-autocomplete-item", item)

                      .append('<a style="color:black">' + item.label + "</a>")
                      .appendTo(ul);
                };


        });
        function checkHidden() {

            $(".ui-helper-hidden-accessible").hide();
        }


        setInterval(function () { loadprice($('#searchID').val(), $('#quantitySKU').val()); }, 100);
        var skupicked = $('#searchID').val();
        var quanitypicked = $('#quantitySKU').val();
        function loadprice(val1, val2) {

            if (val1 != '' && val2 != '' && (val1 != skupicked || val2 != quanitypicked) && val2) {
                skupicked = val1;
                quanitypicked = val2;
                $.get('@(Url.Action("loadPrice", "Warranty",null, Request.Url.Scheme))?code=' + encodeURIComponent(val1) + '&quantity=' + encodeURIComponent(quanitypicked), function (result) {
                    if (result != 0) {
                        $('#skuprice').val(result);
                        $("#searchID").css("background-color", "green");
                    }
                    else {
                        $("#searchID").css("background-color", "red");
                    }

                });
            }

        }
        setInterval(checkHidden, 100);
        setInterval(loadprice, 100);
    </script>
    <style>
        @@import url(http://fonts.googleapis.com/css?family=Roboto:400,500,700,300,100);
div.table-title {
   display: block;
  margin: auto;
  max-width: 600px;
  padding:5px;
  width: 100%;
}

.table-title h3,h6 {
   color: #fafafa;
   font-size: 30px;
   font-weight: 400;
   font-style:normal;
   font-family: "Roboto", helvetica, arial, sans-serif;
   text-shadow: -1px -1px 1px rgba(0, 0, 0, 0.1);
   text-transform:uppercase;
}


/*** Table Styles **/

.table-fill {
  background: white;
  border-radius:3px;
  border-collapse: collapse;
  height: 320px;
  margin: 0;
 padding-top: 100px;
  width: 100%;
  box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
  animation: float 5s infinite;
}
 
th {
  color:#D5DDE5;;
  background:#1b1e24;
  border-bottom:4px solid #9ea7af;
  border-right: 1px solid #343a45;
  font-size:23px;
  font-weight: 100;
  padding:24px;
  text-align:left;
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
  vertical-align:middle;
}

th:first-child {
  border-top-left-radius:3px;
}
 
th:last-child {
  border-top-right-radius:3px;
  border-right:none;
}
  
tr {
  border-top: 1px solid #C1C3D1;
  border-bottom-: 1px solid #C1C3D1;
  color:#666B85;
  font-size:16px;
  font-weight:normal;
  text-shadow: 0 1px 1px rgba(256, 256, 256, 0.1);
}
 

 
tr:first-child {
  border-top:none;
}

tr:last-child {
  border-bottom:none;
}
 

tr:last-child td:first-child {
  border-bottom-left-radius:3px;
}
 
tr:last-child td:last-child {
  border-bottom-right-radius:3px;
}
 
td {
  background:#FFFFFF;
  padding:20px;
  text-align:left;
  vertical-align:middle;
  font-weight:300;
  font-size:18px;
  text-shadow: -1px -1px 1px rgba(0, 0, 0, 0.1);
  border-right: 1px solid #C1C3D1;
}

td:last-child {
  border-right: 0px;
}

th.text-left {
  text-align: left;
}

th.text-center {
  text-align: center;
}

th.text-right {
  text-align: right;
}

td.text-left {
  text-align: left;
}

td.text-center {
  text-align: center;
}

td.text-right {
  text-align: right;
}
    </style>
</head>
<body>

    <div>
        @using (Html.BeginForm("Search", "Warranty"))
                {
   
            <div id="form" class="form-wrapper">
                <table>
                    <tr>
                        <td>
                            <input id="search" class="suggestionsinput" name="code" type="text" placeholder="Nhập mã hóa đơn/mã sản phẩm " required />
                        </td>
                        <td>
                            <button type="submit" value="Search" id="submit">Tìm  </button>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            Tìm theo

                            <input type="radio" name="searchType" checked="checked" value="warrantyCODE"> Mã hóa đơn bảo hành
                            <input type="radio" name="searchType" value="item">Mã sản phẩm <br />
                            <input type="radio" name="searchType" value="warrantyIMEI">  Mã IMEI
                            <input type="radio" name="searchType" value="warrantyCODEDate"> Ngày tháng
                            <input type="radio" name="searchType" value="warrantyCODEPhone">Số điện thoại
                   
                        </td>
                    </tr>
                </table>
       

            </div>




        }



    </div>
    <div>

        @if ((List<tb_warranty>)ViewData["warrantyDetail"] != null
                                )
        {

            foreach (tb_warranty t in (List<tb_warranty>)ViewData["warrantyDetail"])
            {
                <table class="table-fill">

                    <td>
                        <p>Mã bảo hành: @t.warrantyID </p>
                        <p>IMEI sản phẩm: @t.itemID </p>
                        <p>Ngày Kích Hoạt: @t.startdate</p>
                        <p>Thời gian còn lại: @t.duration</p>
                        <p>IMEI Sản phẩm: @t.itemID</p>
                    </td>


                </table>
            }



        }
        @if (ViewData["lsbh"] != null && ((List
        <tb_warranty_activities>
            )ViewData["lsbh"]).Count == 1)
        {
            bool flag = false;
            foreach (var item in (List
            <tb_warranty_activities>
                )ViewData["lsbh"])
            {

                if (item.status != 4)
                {
                    flag = true;
                    List<SelectListItem> ls = new List<SelectListItem> {
     new SelectListItem { Text = "Đang kiểm tra", Value = "1"},
     new SelectListItem { Text = "Đang sửa chữa", Value = "2"},
     new SelectListItem { Text = "Hoàn tất sửa chữa", Value = "3"},
     new SelectListItem { Text  = "Đã bàn giao",Value="4"}

  };

                    
                    using (Html.BeginForm("Update", "Warranty"))
                    {

                        <div style="display:none;">@Html.TextBoxFor(Model => item.id) </div>
                        <div style="display:none;"></div>
                        <div style="display:none;"></div>
                        <div style="display:none;"></div>
                        <table class="table-fill">
                            <tr>
                                <th colspan="2">
                                    <h6>Quản lý quy trình bảo hành của mã bảo hành : @item.CodeBaoHanh </h6>
                                </th>
                            </tr>
                            <tr>
                                <td>Ngày tiếp nhận : </td>
                                <td>@item.startDate </td>
                            </tr>
                            <tr>
                                <td>Nhân viên nhận:</td>
                                <td> @item.AspNetUser.FullName </td>
                            </tr>
                            <tr>
                                <td>Nhân viên đang sửa:</td>
                                <td> @item.AspNetUser1.FullName </td>
                            </tr>
                            <tr>
                                <td>Tình trạng lúc nhận:</td>
                                <td>@item.Description</td>
                            </tr>



                            <tr>
                                <td>Trạng Thái:  </td>
                                <td id="statusWar">@Html.DropDownListFor(Model => item.status, ls)</td>

                            </tr>

                            <tr id="dateBanGiao" style="display: none;">
                                <td>Ngày bàn giao  </td>
                                <td> @Html.TextBoxFor(Model => item.realeaseDATE) </td>
                            </tr>

                            <tr></tr>

                            <tr id="dateFinish" style="display: none;">
                                <td>Ngày sửa xong  </td>
                                <td> @Html.TextBoxFor(Model => item.finishFixingDate) </td>
                            </tr>

                            <tr>
                                <td>
                                    <button type="submit">Cập nhật trạng thái bảo hành</button>
                                </td>
                            </tr>

                        </table>


                    }
                   <br /><br /><br />
                    <table id="fee" class="table-fill">
                        <tr>
                            <th colspan="5">
                                <h6>Linh kiện thay mới</h6>
                            </th>
                        </tr>
                        <tr>
                            <th> Tên Linh Kiện </th>
                            <th> Số lượng</th>
                            <th> Phí thay thế</th>
                            <th> Thêm / Sửa</th>
                            <th> Xóa</th>
                        </tr>
                        <tbody  class="table-hover">
                            @foreach (warrantyActivityFee fee in item.warrantyActivityFees)
                        {
                                <tr>
                                    <td class="text-left">
                                        @fee.productSKU
                                    </td>
                                    <td class="text-left">
                                        @fee.quantity
                                    </td>
                                    <td class="text-left">
                                        @fee.fixingfee
                                    </td>
                                    <td class="text-left"></td>
                                    <td class="text-left">
                                        @using (Html.BeginForm("XoaFee", "Warranty"))
                            {
                                            <input type="hidden" name="feeID" value="@fee.id" />
                                            <input type="hidden" name="activitiesID" value="@item.itemID" />
                                            <input type="submit" name="Xóa" value="Xóa" />
                                        }
                                    </td>



                                </tr>
                            }
                        </tbody>
                        @using (Html.BeginForm("AddFee", "Warranty"))
                        {
                            <tr>
                                <td >
                                    <input type="hidden" name="activitiesID" value="@item.id" />
                                    <input id="searchID" type="text" name="ksu" />
                                </td>
                                <td>
                                    <input id="quantitySKU" type="text" name="quantity" />
                                </td>
                                <td>
                                    <input id="skuprice" type="text" name="fixPrice" />
                                </td>
                                <td>
                                    <input type="submit" name="ThêmS" />
                                </td>
                            </tr>
                        }

                    </table>

                    <br /><br /><br />
                    <table class="table-fill">
                        <tr>
                            <th colspan="4">
                                <h6> Sửa chữa khác </h6>
                            </th>
                        </tr>
                        <tr>
                            <th> Mô tả </th>
                            <th>  Tiền công</th>
                            <th> Thêm </th>
                            <th> Xóa</th>
                        </tr>
                        @foreach (warrantyActivityFixingFee fee in item.warrantyActivityFixingFees)
                        {
                            <tr>
                                <td>
                                    @fee.FixDetail
                                </td>
                                <td>
                                    @fee.fee
                                </td>
                                <td></td>
                                <td>
                                    @using (Html.BeginForm("XoaFixingFee", "Warranty"))
                                    {<input type="hidden" name="feeID" value="@fee.id" />
                                        <input type="hidden" name="activitiesID" value="@item.itemID" />
                                        <input type="submit" name="Xóa" value="Xóa" />
                                    }
                                </td>

                            </tr>
                        }

                        @using (Html.BeginForm("AddFixingFee", "Warranty"))
                        {
                            <tr>
                                <td>
                                    <input type="hidden" name="activitiesID" value="@item.id" />
                                    <input type="text" name="fixDetail" />
                                </td>
                                <td>
                                    <input type="text" name="price" />
                                </td>
                                <td>
                                    <input type="submit" name="ThêmS" />
                                </td>
                            </tr>
                        }
                    </table>
                }


            }
            if (!flag && (List
            <tb_warranty>
                )ViewData["warrantyDetail"] != null && ((List<tb_warranty>
                    )ViewData["warrantyDetail"]).Count() == 1)
            {

                tb_warranty t = ((List<tb_warranty>
                    )ViewData["warrantyDetail"]).ElementAt(0);

                <button id="startWarranty"> Bắt đầu quy trình bảo hành</button>
                                    <div id="newWarrantyForm" style="display:none">
                                        @using (Html.BeginForm("Add", "Warranty"))
                                        {
                                            tb_warranty_activities t2 = new tb_warranty_activities();
                                            t2.warrantyID = t.warrantyID;
                                            t2.itemID = t.itemID;

                                            <div>
                                                @Html.TextBoxFor(item => t2.warrantyID, new { @Value = t.warrantyID })
                                                @Html.TextBoxFor(item => t2.itemID, new { @Value = t.itemID })

                                            </div>
                                            <table class="table-fill">
                                                <tr>
                                                    <td>
                                                        Ngày nhận:
                                                    </td>
                                                    <td>
                                                        @Html.TextBoxFor(item => t2.startDate)

                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Nhân Viên chịu trách nhiệm
                                                    </td>
                                                    <td>
                                                        @Html.TextBoxFor(item => t2.employee)
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        Tình trạng lúc nhận
                                                    </td>
                                                    <td>
                                                        @Html.TextBoxFor(item => t2.Description)
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <button type="summit"> Bắt đầu</button>
                                                </tr>
                                            </table>
                                        }
                                    </div>


            }
        }


        @if (ViewData["lsbh"] != null && ((List<tb_warranty_activities>)ViewData["lsbh"]).Count() > 0
                        )
        {
            <br /><br /><br />
            
                                        <table class="table-fill">
                                            <tr>
                                                <th colspan="8"> <h6> Lịch Sử Bảo Hành </h6></th>
                                            </tr>
                                            <tr><th>Mã bill bảo hành   </th>
                                                <th>Ngày nhận  </th>
                                                <th>Nhân viên nhận </th>
                                                <th>Nhân viên sửa </th>
                                                <th>Tình trạng lúc nhận </th>
                                                <th>  Ngày hoàn tất sửa </th>
                                                <th>  Ngày Trả </th>
                                                <th>  Chi tiết  </th>
                                            </tr>

                                            @foreach (var item in (List <tb_warranty_activities>)ViewData["lsbh"])
                                            {

                                                <tr>
                                                    <td>@item.CodeBaoHanh </td>
                                                    <td>@item.startDate </td>
                                                    <td>@item.AspNetUser.FullName </td>
                                                    <td>@item.AspNetUser1.FullName </td>
                                                    <td>@item.tb_warrnaty_status.statusName </td>
                                                    <td>@item.finishFixingDate</td>
                                                    <td>@item.realeaseDATE </td>
                                                    @using (Html.BeginForm("Search", "Warranty"))
                                                    {
                                                        <td>
                                                            <input type="hidden" value="@item.id" name="code" />
                                                            <input type="hidden" value="warrantyActID" name="searchType" />
                                                            <button type="submit"  value="submit" name="submit" > Chi tiết</button>
                                                        </td>
                                                    }
                                                   

                                                </tr>


                                            }

                                        </table>


        }
        @if (ViewData["alsbh"] != null && ((List<tb_warranty_activities>)ViewData["alsbh"]).Count() > 0
                        )
        {
            <h1> Lịch Sử Bảo Hành của sản phẩm </h1>
                                        <table class="table-fill">
                                            <tr>
                                                <th>Mã bảo hành  </th>
                                                <th>Ngày nhận  </th>
                                                <th>Nhân Viên Nhận </th>
                                                <th>Nhân Viên Sửa </th>
                                                <th>Tình trạng </th>
                                                <th>  Ngày hoàn tất sửa </th>
                                                <th>  Ngày Trả </th>
                                            </tr>

                                            @foreach (var item in (List
<tb_warranty_activities>
)ViewData["alsbh"])
                                            {

                                                <tr>
                                                    <td>@item.warrantyID </td>
                                                    <td>@item.startDate </td>
                                                    <td>@item.AspNetUser.FullName </td>
                                                    <td>@item.AspNetUser1.FullName </td>
                                                    <td>@item.tb_warrnaty_status.statusName </td>
                                                    <td>@item.finishFixingDate</td>
                                                    <td>@item.realeaseDATE </td>

                                                </tr>


                                            }
                                        </table>


        }
    </div>
</body>
</html>
